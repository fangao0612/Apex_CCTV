<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta name="x-poe-datastore-behavior" content="local_only">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' data: blob: https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://code.jquery.com https://unpkg.com https://d3js.org https://threejs.org https://cdn.plot.ly https://stackpath.bootstrapcdn.com https://maps.googleapis.com https://cdn.tailwindcss.com https://ajax.googleapis.com https://kit.fontawesome.com https://cdn.datatables.net https://maxcdn.bootstrapcdn.com https://code.highcharts.com https://tako-static-assets-production.s3.amazonaws.com https://www.youtube.com https://fonts.googleapis.com https://fonts.gstatic.com https://pfst.cf2.poecdn.net https://puc.poecdn.net https://i.imgur.com https://wikimedia.org https://*.icons8.com https://*.giphy.com https://picsum.photos https://images.unsplash.com; frame-src 'self' https://www.youtube.com https://trytako.com; child-src 'self'; manifest-src 'self'; worker-src 'self'; upgrade-insecure-requests; block-all-mixed-content;">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>用户管理 - 极简布局骨架</title>
  <style>
    /* 延续 device_management.html/admin_panel.html 的“极简黑描边骨架”风格 */
    * { box-sizing: border-box; }
    html, body { height: 100%; margin: 0; }
    body { font-family: sans-serif; }
    button, input, select { font: inherit; }
    a { color: inherit; }

    .app { height: 100%; display: flex; flex-direction: column; min-height: 0; }

    /* 顶部导航 */
    .topbar {
      height: 56px;
      display: flex;
      align-items: stretch;
      border-bottom: 1px solid #000;
    }
    .top-left {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 0 12px;
      min-width: 240px;
      border-right: 1px solid #000;
      white-space: nowrap;
    }
    .top-left a { color: inherit; text-decoration: none; cursor: pointer; }
    .top-left a:hover { text-decoration: underline; }
    .top-center { display: flex; align-items: stretch; gap: 0; flex: 1; }
    .nav-item {
      display: flex;
      align-items: center;
      padding: 0 18px;
      border-right: 1px solid #000;
      cursor: pointer;
      user-select: none;
      position: relative;
      gap: 8px;
    }
    .nav-item[aria-current="page"] { font-weight: 700; }
    .dropdown {
      display: none;
      position: absolute;
      top: 56px;
      left: 0;
      border: 1px solid #000;
      background: #fff;
      min-width: 160px;
      z-index: 10;
    }
    .dropdown a {
      display: block;
      padding: 10px 12px;
      border-bottom: 1px solid #000;
      text-decoration: none;
    }
    .dropdown a:hover { text-decoration: underline; }
    .dropdown a:last-child { border-bottom: 0; }
    .nav-item.open .dropdown { display: block; }
    .top-right {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 0 12px;
      min-width: 360px;
      border-left: 1px solid #000;
      white-space: nowrap;
    }
    .top-right input { width: 100%; }

    /* 主体 */
    .main { flex: 1; min-height: 0; display: grid; grid-template-rows: 44px 1fr; }
    .breadcrumb {
      border-bottom: 1px solid #000;
      padding: 10px 12px;
      display: flex;
      align-items: center;
      gap: 8px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .page { min-height: 0; overflow: auto; padding: 12px; }

    .toolbar {
      border: 1px solid #000;
      padding: 10px;
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 10px;
      align-items: center;
    }
    .toolbar-left { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; }
    .toolbar-left button {
      padding: 6px 10px;
      border: 1px solid #000;
      background: transparent;
      cursor: pointer;
    }
    .toolbar-right {
      display: grid;
      grid-template-columns: 1fr 44px;
      gap: 6px;
      align-items: center;
      min-width: 280px;
    }

    .table-wrap {
      margin-top: 10px;
      border: 1px solid #000;
      overflow: auto;
      min-height: 0;
    }
    table { width: 100%; border-collapse: collapse; min-width: 980px; }
    thead th {
      position: sticky;
      top: 0;
      background: #fff;
      border-bottom: 1px solid #000;
      padding: 10px 8px;
      text-align: left;
      white-space: nowrap;
    }
    tbody td {
      border-top: 1px solid #000;
      padding: 10px 8px;
      vertical-align: top;
      white-space: nowrap;
    }
    tbody tr:hover { background: #f6f6f6; }

    .ops { display: flex; gap: 6px; align-items: center; }
    .ops button {
      padding: 4px 8px;
      border: 1px solid #000;
      background: transparent;
      cursor: pointer;
    }

    .pager {
      margin-top: 10px;
      display: flex;
      justify-content: space-between;
      gap: 10px;
      align-items: center;
      padding: 10px;
      border: 1px solid #000;
    }
    .pager .left { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
    .pager .right { display: flex; gap: 6px; align-items: center; }

    dialog {
      border: 1px solid #000;
      padding: 0;
      width: min(720px, calc(100% - 24px));
    }
    dialog::backdrop { background: rgba(0,0,0,.2); }
    .dlg-hd {
      border-bottom: 1px solid #000;
      padding: 10px 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }
    .dlg-bd { padding: 12px; }
    .form-grid {
      display: grid;
      grid-template-columns: 120px 1fr;
      gap: 10px;
      align-items: center;
    }
    .dlg-ft {
      border-top: 1px solid #000;
      padding: 10px 12px;
      display: flex;
      justify-content: flex-end;
      gap: 8px;
    }

    @media (max-width: 900px) {
      .top-right { min-width: 220px; }
      .toolbar { grid-template-columns: 1fr; }
      .toolbar-right { min-width: 0; }
      table { min-width: 900px; }
    }
  </style>
</head>

<body>
  <div class="app">
    <header class="topbar" role="banner">
      <div class="top-left">
        <strong>Apex CCTV</strong>
        <span>|</span>
        <a href="homepage.html">首页</a>
      </div>

      <nav class="top-center" aria-label="主导航">
        <div class="nav-item" data-nav="video">
          <a href="admin_panel.html" style="text-decoration:none;">视频</a>
        </div>

        <div class="nav-item" data-nav="device">
          设备
          <div class="dropdown" role="menu" aria-label="设备菜单">
            <a href="device_management.html" role="menuitem">设备管理</a>
            <a href="#" role="menuitem">分组管理</a>
          </div>
        </div>

        <div class="nav-item" aria-current="page" data-nav="user">
          用户
          <div class="dropdown" role="menu" aria-label="用户菜单">
            <a href="user_management.html" role="menuitem">用户管理</a>
            <a href="#" role="menuitem">角色管理</a>
          </div>
        </div>

        <div class="nav-item" data-nav="gallery">
          图库
          <div class="dropdown" role="menu" aria-label="图库菜单">
            <a href="#" role="menuitem">网关告警</a>
            <a href="#" role="menuitem">协议告警</a>
            <a href="#" role="menuitem">1400告警</a>
          </div>
        </div>

        <div class="nav-item" data-nav="ai">AI 分析</div>

        <div class="nav-item" data-nav="config">
          配置
          <div class="dropdown" role="menu" aria-label="配置菜单">
            <a href="#" role="menuitem">基础配置</a>
            <a href="#" role="menuitem">录像配置</a>
            <a href="#" role="menuitem">告警配置</a>
            <a href="#" role="menuitem">设备接入</a>
            <a href="#" role="menuitem">运维管理</a>
          </div>
        </div>
      </nav>

      <div class="top-right">
        <span>功能搜索</span>
        <input placeholder="请输入搜索内容" aria-label="功能搜索">
        <span>管理员</span>
      </div>
    </header>

    <div class="main">
      <div class="breadcrumb" aria-label="面包屑">
        <strong>用户管理</strong>
        <span>|</span>
        <span>用户</span>
      </div>

      <section class="page" aria-label="用户管理内容区">
        <div class="toolbar" aria-label="用户管理工具栏">
          <div class="toolbar-left">
            <button type="button" id="btnAdd">+ 添加用户</button>
            <button type="button" id="btnImport">导入</button>
            <button type="button" id="btnExport">导出</button>
            <input id="fileImport" type="file" accept=".csv,text/csv" style="display:none;">

            <label>
              <span style="margin-right:6px;">角色</span>
              <select id="filterRole" aria-label="角色筛选">
                <option value="">全部</option>
                <option value="admin">admin</option>
                <option value="operator">operator</option>
                <option value="viewer">viewer</option>
              </select>
            </label>
          </div>

          <div class="toolbar-right">
            <input id="keyword" placeholder="用户名 / 昵称 / 角色" aria-label="关键字搜索">
            <button type="button" id="btnSearch">搜</button>
          </div>
        </div>

        <div class="table-wrap" aria-label="用户表格容器">
          <table aria-label="用户列表">
            <thead>
              <tr>
                <th style="width:90px;">ID</th>
                <th style="width:220px;">用户登录名</th>
                <th style="width:220px;">用户昵称</th>
                <th style="width:160px;">角色名称</th>
                <th style="width:220px;">创建时间</th>
                <th style="width:140px;">操作</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>

        <div class="pager" aria-label="分页">
          <div class="left">
            <span id="countText">共 0 条</span>
            <label>
              每页
              <select id="pageSize">
                <option value="5">5</option>
                <option value="10" selected>10</option>
                <option value="20">20</option>
              </select>
              条
            </label>
          </div>
          <div class="right">
            <button type="button" id="btnPrev">上一页</button>
            <span id="pageText">第 1 / 1 页</span>
            <button type="button" id="btnNext">下一页</button>
          </div>
        </div>
      </section>

    </div>
  </div>

  <dialog id="dlg">
    <div class="dlg-hd">
      <strong id="dlgTitle">添加用户</strong>
      <button type="button" id="btnCloseDlg">关闭</button>
    </div>
    <div class="dlg-bd">
      <form id="formUser">
        <div class="form-grid">
          <label for="fUsername">登录名</label>
          <input id="fUsername" required placeholder="例如：easycvr">

          <label for="fNickname">昵称</label>
          <input id="fNickname" required placeholder="例如：管理员">

          <label for="fRole">角色</label>
          <select id="fRole" required>
            <option value="admin">admin</option>
            <option value="operator">operator</option>
            <option value="viewer">viewer</option>
          </select>

          <label for="fPassword">密码</label>
          <input id="fPassword" type="password" placeholder="编辑时留空表示不修改">
        </div>
      </form>
    </div>
    <div class="dlg-ft">
      <button type="button" id="btnCancel">取消</button>
      <button type="button" id="btnSave">保存</button>
    </div>
  </dialog>

  <script>
    // 顶部“下拉菜单”点击开合（同其它页面）
    const navItems = document.querySelectorAll('.nav-item');
    function closeAll() { navItems.forEach(i => i.classList.remove('open')); }
    navItems.forEach(item => {
      item.addEventListener('click', (e) => {
        const hasDropdown = item.querySelector('.dropdown');
        if (!hasDropdown) { closeAll(); return; }
        const isOpen = item.classList.contains('open');
        closeAll();
        if (!isOpen) item.classList.add('open');
        e.stopPropagation();
      });
    });
    document.addEventListener('click', closeAll);
    document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeAll(); });

    // 用户页：基础数据与交互（纯前端占位）
    /** @type {{id:number, username:string, nickname:string, role:string, createdAt:string}[]} */
    let users = [
      { id: 1, username: 'easycvr', nickname: '管理员', role: 'admin', createdAt: '2026-01-23 17:18:13' },
      { id: 2, username: '123', nickname: '123', role: '1212', createdAt: '2026-01-23 17:18:13' },
    ];

    let page = 1;
    let pageSize = 10;

    const tbody = document.getElementById('tbody');
    const countText = document.getElementById('countText');
    const pageText = document.getElementById('pageText');
    const btnPrev = document.getElementById('btnPrev');
    const btnNext = document.getElementById('btnNext');
    const keywordEl = document.getElementById('keyword');
    const filterRoleEl = document.getElementById('filterRole');
    const pageSizeEl = document.getElementById('pageSize');

    function normalize(s) { return String(s ?? '').trim().toLowerCase(); }

    function getFiltered() {
      const kw = normalize(keywordEl.value);
      const role = filterRoleEl.value;
      return users.filter(u => {
        const kwHit = !kw || (
          normalize(u.username).includes(kw) ||
          normalize(u.nickname).includes(kw) ||
          normalize(u.role).includes(kw)
        );
        const roleHit = !role || u.role === role;
        return kwHit && roleHit;
      });
    }

    function render() {
      const filtered = getFiltered();
      const total = filtered.length;
      const totalPages = Math.max(1, Math.ceil(total / pageSize));
      if (page > totalPages) page = totalPages;
      if (page < 1) page = 1;

      const start = (page - 1) * pageSize;
      const rows = filtered.slice(start, start + pageSize);

      countText.textContent = `共 ${total} 条`;
      pageText.textContent = `第 ${page} / ${totalPages} 页`;
      btnPrev.disabled = page <= 1;
      btnNext.disabled = page >= totalPages;

      tbody.innerHTML = rows.map(u => `
        <tr data-id="${u.id}">
          <td>${u.id}</td>
          <td>${escapeHtml(u.username)}</td>
          <td>${escapeHtml(u.nickname)}</td>
          <td>${escapeHtml(u.role)}</td>
          <td>${escapeHtml(u.createdAt)}</td>
          <td>
            <div class="ops">
              <button type="button" data-act="edit">编辑</button>
              <button type="button" data-act="delete">删除</button>
            </div>
          </td>
        </tr>
      `).join('');
    }

    function escapeHtml(str) {
      return String(str ?? '')
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#39;');
    }

    // 分页
    btnPrev.addEventListener('click', () => { page -= 1; render(); });
    btnNext.addEventListener('click', () => { page += 1; render(); });
    pageSizeEl.addEventListener('change', () => {
      pageSize = Number(pageSizeEl.value) || 10;
      page = 1;
      render();
    });

    // 搜索/筛选
    document.getElementById('btnSearch').addEventListener('click', () => { page = 1; render(); });
    keywordEl.addEventListener('keydown', (e) => { if (e.key === 'Enter') { page = 1; render(); } });
    filterRoleEl.addEventListener('change', () => { page = 1; render(); });

    // 表格操作
    tbody.addEventListener('click', (e) => {
      const target = e.target;
      if (!(target instanceof HTMLElement)) return;
      const tr = target.closest('tr');
      if (!tr) return;
      const id = Number(tr.getAttribute('data-id'));
      const u = users.find(x => x.id === id);
      if (!u) return;
      const act = target.getAttribute('data-act');
      if (!act) return;

      if (act === 'delete') {
        if (!confirm(`确定删除用户「${u.username}」？`)) return;
        users = users.filter(x => x.id !== id);
        render();
        return;
      }
      if (act === 'edit') {
        openDialog('edit', u);
      }
    });

    // 导出 CSV（当前筛选后的全部）
    document.getElementById('btnExport').addEventListener('click', () => {
      const filtered = getFiltered();
      const headers = ['id','username','nickname','role','createdAt'];
      const lines = [
        headers.join(','),
        ...filtered.map(u => headers.map(k => csvCell(u[k])).join(',')),
      ];
      const blob = new Blob([lines.join('\n')], { type: 'text/csv;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `users_${new Date().toISOString().slice(0,10)}.csv`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    });

    function csvCell(v) {
      const s = String(v ?? '');
      const escaped = s.replaceAll('"', '""');
      return `"${escaped}"`;
    }

    // 导入 CSV（简单追加）
    const fileImport = document.getElementById('fileImport');
    document.getElementById('btnImport').addEventListener('click', () => fileImport.click());
    fileImport.addEventListener('change', async () => {
      const file = fileImport.files?.[0];
      if (!file) return;
      const text = await file.text();
      const rows = parseCsv(text);
      if (!rows.length) { alert('导入失败：CSV 为空'); return; }
      const headers = rows[0].map(h => normalize(h));
      const idx = (name) => headers.indexOf(normalize(name));
      const required = ['username','nickname','role'];
      const missing = required.filter(k => idx(k) < 0);
      if (missing.length) { alert(`导入失败：缺少列 ${missing.join(', ')}`); return; }

      let nextId = Math.max(0, ...users.map(u => u.id)) + 1;
      let added = 0;
      const now = new Date();
      const ts = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')} ${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}:${String(now.getSeconds()).padStart(2,'0')}`;

      for (const r of rows.slice(1)) {
        const username = r[idx('username')]?.trim();
        const nickname = r[idx('nickname')]?.trim();
        const role = r[idx('role')]?.trim();
        if (!username || !nickname || !role) continue;
        users.push({ id: nextId++, username, nickname, role, createdAt: r[idx('createdAt')]?.trim() || ts });
        added += 1;
      }
      alert(`导入完成：新增 ${added} 条`);
      fileImport.value = '';
      render();
    });

    function parseCsv(text) {
      // 极简 CSV 解析（支持双引号，逗号分隔；不处理多行字段）
      const lines = String(text ?? '').split(/\r?\n/).filter(l => l.trim().length);
      return lines.map(line => {
        const out = [];
        let cur = '';
        let inQuote = false;
        for (let i = 0; i < line.length; i++) {
          const ch = line[i];
          if (ch === '"') {
            if (inQuote && line[i + 1] === '"') { cur += '"'; i++; continue; }
            inQuote = !inQuote;
            continue;
          }
          if (ch === ',' && !inQuote) { out.push(cur); cur = ''; continue; }
          cur += ch;
        }
        out.push(cur);
        return out;
      });
    }

    // 弹窗：添加/编辑
    const dlg = document.getElementById('dlg');
    const dlgTitle = document.getElementById('dlgTitle');
    const fUsername = document.getElementById('fUsername');
    const fNickname = document.getElementById('fNickname');
    const fRole = document.getElementById('fRole');
    const fPassword = document.getElementById('fPassword');
    let editingId = null;

    function openDialog(mode, u) {
      editingId = mode === 'edit' ? u.id : null;
      dlgTitle.textContent = mode === 'edit' ? '编辑用户' : '添加用户';
      fUsername.value = mode === 'edit' ? u.username : '';
      fUsername.disabled = mode === 'edit'; // 编辑时不修改登录名（占位规则）
      fNickname.value = mode === 'edit' ? u.nickname : '';
      fRole.value = mode === 'edit' ? u.role : 'viewer';
      fPassword.value = '';
      dlg.showModal();
    }

    function closeDialog() { dlg.close(); }
    document.getElementById('btnAdd').addEventListener('click', () => openDialog('add'));
    document.getElementById('btnCloseDlg').addEventListener('click', closeDialog);
    document.getElementById('btnCancel').addEventListener('click', closeDialog);
    dlg.addEventListener('click', (e) => {
      const rect = dlg.getBoundingClientRect();
      const inDialog = e.clientX >= rect.left && e.clientX <= rect.right && e.clientY >= rect.top && e.clientY <= rect.bottom;
      if (!inDialog) closeDialog();
    });

    document.getElementById('btnSave').addEventListener('click', () => {
      const form = document.getElementById('formUser');
      if (!form.reportValidity()) return;

      const payload = {
        username: fUsername.value.trim(),
        nickname: fNickname.value.trim(),
        role: fRole.value,
        password: fPassword.value, // 占位：不落地存储
      };
      if (!payload.username || !payload.nickname || !payload.role) return;

      if (editingId != null) {
        const u = users.find(x => x.id === editingId);
        if (u) {
          u.nickname = payload.nickname;
          u.role = payload.role;
        }
      } else {
        if (users.some(u => normalize(u.username) === normalize(payload.username))) {
          alert('添加失败：登录名已存在');
          return;
        }
        const nextId = Math.max(0, ...users.map(u => u.id)) + 1;
        const now = new Date();
        const createdAt = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')} ${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}:${String(now.getSeconds()).padStart(2,'0')}`;
        users.unshift({ id: nextId, username: payload.username, nickname: payload.nickname, role: payload.role, createdAt });
      }
      closeDialog();
      render();
    });

    // 初次渲染
    render();
  </script>
</body>
</html>
