## 重要信息汇总（截至目前对话）

### 目标
把 `admin_panel.html` 从“展示 URL + 占位画面”改成完整链路：**登录拿 Token → 拉设备/通道 → 点击通道拿可播 URL → 真正在浏览器播放（HLS/FLV/WebRTC）**。

---

## 1) 已确认的服务器与基础地址（Base URL）
- 后台页面实际打开地址：`13.238.254.66:18000/#/config/base`
- **API Base URL**：`http://13.238.254.66:18000`（HTTP，非 HTTPS）

---

## 2) Token / 鉴权要点

### 2.1 登录 Token（JWT）
- 用途：调用管理类接口时放在请求头：`Token: <登录JWT>`

### 2.2 播放 Token（play_token）
- 来源：`/api/v1/devices/channelstreamalladdr` 返回的各协议播放 URL 上的 `play_token=...`
- 用途：拉 HLS/FLV/WebRTC 流时的授权参数
- 说明：它看起来也像 JWT，但它是**播放用 token**，不是请求头里的登录 Token

---

## 3) 已确认的关键接口（EasyDarwin/EasyCVR 风格）

### 3.1 通道列表（必须先拿到通道标识）
- **接口**：`GET /api/v1/channelsconfig`
- **Query 参数**
  - `device`（string，必需）：设备ID（平台内部设备主键）
  - `start`（string，必需）：分页起始（示例 `0`）
  - `limit`（string，必需）：分页数量（示例 `50` / `500`）
  - `q`（string，可选）：搜索
- **Header**
  - `Token`：登录 JWT
- **返回结构**
  - `EasyDarwin.Header.ErrorNum == "200"` 表示请求成功
  - `EasyDarwin.Body.ChannelCount`：通道数量
  - `EasyDarwin.Body.Channels[]`：通道数组
- **通道对象常用字段（示例里出现过）**
  - `ParentDeviceID`：设备ID（后续取流用）
  - `ChannelID`：通道ID（后续取流用）
  - `Name`：通道名称
  - `Online`：在线状态
  - `RtspUrl`：摄像机 RTSP（浏览器通常不能直接播）
  - `Token`：通道 token（示例 `8qmVTZLS`，可能用于别的接口/场景）

> 你实际请求过：`http://13.238.254.66:18000/api/v1/channelsconfig?start=0&limit=500&device=1`  
> 返回 `ChannelCount: 0`，说明 **device=1 在你当前环境下没有通道**（请求本身成功）。

### 3.2 获取流地址（一次返回所有协议地址 + play_token）
- **接口**：`GET /api/v1/devices/channelstreamalladdr`
- **Query 参数**
  - `device`（string，必需）：设备ID
  - `channel`（string，必需）：通道ID
- **Header**
  - `Token`：登录 JWT
- **返回结构（关键字段）**
  - `EasyDarwin.Body.WEBRTC`：`/rtc/stream_1_0?play_token=...`
  - `EasyDarwin.Body.HLS`：`/hls/stream_1_0/playlist.m3u8?play_token=...`
  - `EasyDarwin.Body.FLV`：`/flv/live/stream_1_0.flv?play_token=...`
  - `EasyDarwin.Body.WS_FLV`：`/ws_flv/live/stream_1_0.flv?play_token=...`
  - `EasyDarwin.Body.FMP4`、`WS_FMP4` 等
  - `EasyDarwin.Body.KeepaliveURL`：示例值仍是 `/api/v1/devices/channelstreamalladdr`（提示该接口可能兼做保活/续期触发点）
  - `EasyDarwin.Body.SnapURL`：抓图地址

**相对路径 → 完整可播 URL 拼接规则**：`fullUrl = baseUrl + relativePath`  
例如：`http://13.238.254.66:18000` + `EasyDarwin.Body.HLS`

---

## 4) 设备ID（deviceId）是什么、怎么拿

### 4.1 设备ID含义
- `device` 参数是平台内部的设备主键/编号（不是 IP、不是 GB ID、不是序列号）
- 通常对应后台“设备管理”列表里的 **编号**

### 4.2 当前环境结论
- 设备管理页显示“编号”：**8、22、24、26、27**（像真实 deviceId）
- `device=1` 返回无通道：不是权限问题，是该 device 在当前环境下确实没通道
- 你填 `device=8` 后树里出现通道：**device=8 很可能是正确 deviceId**

---

## 5) 当前链路完成度（状态判断）

### 5.1 已成功的部分
- 能登录并保存 Token
- 能选择正确 deviceId（`device=8` 后通道树出现）
- 能调用 `channelstreamalladdr` 拿到完整播放 URL（例如 HLS 的 `playlist.m3u8?play_token=...`）

### 5.2 仍未成功的部分（黑屏、0:00）
- **拿到 URL ≠ 浏览器能播放出画面**
- 当前真实根因已确认：该通道输出 **H265/HEVC**，浏览器端（HLS/hls.js、FLV/flv.js）通常无法解码，导致前端一直 `wh=0x0` 黑屏。

---

## 6) 为什么会“有 URL 但不播放”（关键结论）

### 6.1 协议与浏览器支持差异
- **WS-FLV / HTTP-FLV**：浏览器不能原生播放，需要 `flv.js`（MSE）
- **HLS(m3u8)**：
  - Safari 通常原生支持
  - Chrome/Edge 通常不可靠（常需 `hls.js`）
- **WebRTC**：浏览器支持，但很多平台 `/rtc/...` 可能需要特定对接方式（有时能直连，有时需要额外流程/SDK）

### 6.2 你当前现象最可能原因
- 已定位的真实原因（已通过 `streamInfo` 证实）：
  - 平台实际输出：`video_codec=H265`，分辨率 `2560x1440`，`fps≈25`，音频 `AAC`
  - 结果：浏览器侧无法解码 → `<video>` 的 `videoWidth/videoHeight` 一直为 `0x0` → 黑屏
- 备注：
  - VLC 等桌面播放器自带 H265 解码，所以 **VLC 能播 ≠ 网页能播**

---

## 6.3 跨域（CORS）与访问方式关键结论
- 如果用 `file://` 打开 `admin_panel.html`，浏览器通常会因为 CORS 限制而无法拉取 HLS 分片/FLV 数据，表现为黑屏/报错。
- 推荐使用本项目提供的本地反向代理脚本，通过 `http://127.0.0.1:<port>/admin_panel.html` 打开页面，确保同源访问。

---

## 7) 推荐的播放策略（优先级）
更稳的前端策略（结合当前现状）：
1. **前提：平台输出必须是 H264**（浏览器端解码能力决定了这点；H265 会直接黑屏）
2. **HLS + hls.js**（兼容性最好，延迟较高）
3. **HTTP-FLV + flv.js**（延迟较低，依赖 MSE）
4. WebRTC/WS-FLV/WS-FMP4：通常需要厂家专用对接/SDK，当前页面未实现

---

## 8) 黑屏定位的最关键验证项（排查清单）
需要确认两点之一：
1. 把 m3u8 URL 新标签打开：是否能看到 `#EXTM3U` 内容，或是否 401/403/404  
2. F12 → Network：`playlist.m3u8` 以及后续分片（`.ts` / `.m4s`）请求状态码是否 200

这能判断是：
- 浏览器不支持（应接入 `hls.js` / `flv.js`）
- 还是鉴权/跨域/分片路径问题

---

## 9) 新增接口：获取流信息（用于确认编码/分辨率，定位黑屏根因）
- **接口**：`GET /api/v1/streamInfo`
- **Query 参数**
  - `url`（必需）：视频流地址（示例：`http://13.238.254.66:18000/hls/.../playlist.m3u8?play_token=...` 或 `.../flv/...flv?play_token=...`）
  - `channel`（必需）：通道ID
- **Header**
  - `Token`（可选/建议）：登录 JWT
- **返回关键字段**
  - `video_codec`：`H264` / `H265`（网页能否播放的关键）
  - `video_width` / `video_height` / `fps`
  - `audio_codec`
  - `pub_bitrate` / `pub_start_time` 等
- **本次实际验证结果（示例）**
  - `video_codec: H265`
  - `video_width/height: 2560x1440`
  - `fps: 25`
  - `audio_codec: AAC`
  - 结论：网页端黑屏是 H265 解码不支持导致

---

## 10) 本地反向代理（解决 file:// 与跨域问题）
- 脚本：`proxy_server.py`
- 作用：本地启动静态站点 + 反向代理 `/api/ /hls/ /flv/ /rtc/ ...` 到真实平台，避免 CORS
- 用法（示例 9000 端口）：
  - `cd "E:\\My Apps and Websites_E\\CCTV"`
  - `python proxy_server.py 9000`
  - 浏览器打开：`http://127.0.0.1:9000/admin_panel.html`
  - 页面 Base URL 填：`http://127.0.0.1:9000`

---

## 11) 要让网页真正出画面的必要条件（结论）
- **必须把该通道输出改为 H264**（音频 AAC 建议保留），分辨率建议先降到 `1920x1080` 或 `1280x720` 再验证。
- 可选路径：
  - 摄像机/NVR/国标设备侧：把主/子码流编码改 H264
  - 平台侧：开启 H265→H264 转码（若有该模块）

---

## 12) 已验证：H265 在网页端“能播”的方案（关键突破）
### 12.1 背景
- 当前通道通过 `GET /api/v1/streamInfo` 确认：
  - `video_codec = H265`
  - `video_width/height = 2560x1440`
  - `audio_codec = AAC`
- 结论：浏览器通用方案（`hls.js` / `flv.js`）通常无法解码 H265 → 表现为 `videoWidth/videoHeight = 0x0` 黑屏。

### 12.2 解决结果
- 已验证：引入 **EasyPlayer.js（开源 H5 播放器）** 后，网页端可直接播放 **H265**（通过 WASM/WebCodec/MSE 等方式，视浏览器能力自动选择）。
- 这意味着：在不改摄像机编码、不做服务器转码的前提下，**前端播放器换成支持 H265 的 SDK** 可以解决“黑屏”问题（前提：浏览器/环境支持该 SDK 的解码路径）。

---

## 13) 官方 demo 为什么能播（与我们最初方案差异点）
### 13.1 关键差异
- 我们最初用：`hls.js / flv.js`（解封装 + MSE 喂数据，但最终解码依赖浏览器原生能力 → H265 常失败）
- 官方 demo 使用了专用播放器链路（你观测到页面加载 `EasyPlayer-pro.js` 且 `<video src="blob:...">`）
- demo 调用了保活接口：
  - `GET /api/v1/devices/channelstream`（带 `type=keepalive`、`protocol=flv`、`stream=main` 等参数）

### 13.2 结论
- “同样是 Chrome，demo 能播而我们不能播”的根因不是浏览器差异，而是 **播放器链路/解码方式不同**。
- `<video src="blob:...">` 通常是 MSE 方案的表现，并不等于浏览器端“转码”；但专用播放器可能通过 wasm/webcodecs 等支持 HEVC。

---

## 14) 前端实现与调试要点（我们踩到并修过的坑）
### 14.1 CSP（Content-Security-Policy）
- `flv.js` 可能使用 `blob:` worker，若 CSP 中 `worker-src` 不允许 `blob:`，会导致播放失败。
- 已在 `admin_panel.html` 中放开：`worker-src 'self' blob:`
- `connect-src` / `media-src` 需覆盖：
  - 页面实际域名（例如 `http://127.0.0.1:9000`）
  - 平台域名（例如 `http://13.238.254.66:18000`）
  - 以及必要的 CDN（若使用）

### 14.2 访问方式与 CORS
- 用 `file://` 直接打开网页经常触发跨域限制，导致 HLS 分片/FLV 请求失败。
- 推荐通过本地/线上 Web 服务器同源访问，必要时做反向代理。

---

## 15) 上线部署结论：Vercel / Railway / Docker / R2 是否需要？
### 15.1 前端网站（管理平台 UI + 播放 SDK）
- 这是一个 **静态站点**（HTML/JS/WASM），上线只需把静态文件一起部署即可：
  - 页面文件（例如 `admin_panel.html`）
  - 播放 SDK 的 `js/wasm/worker` 等资源（建议整体目录一起带上）
- **不强制需要 Docker**：
  - Docker 仅用于把静态站点打包成容器（例如 Nginx 容器），便于标准化部署/回滚。

### 15.2 Vercel 可以吗？
- **可以用于托管前端静态站**（页面 + SDK 静态资源）。
- 但要注意：若视频平台与前端域名不同，可能遇到：
  - CORS
  - WebSocket（`ws_flv`）反代
  - 同源 cookie/token
- 解决方式通常是：在你可控的域名下做反向代理（Nginx/IIS/自建网关），让 `/api /hls /flv /ws_flv` 走同域。

### 15.3 Railway 需要吗？
- **不一定需要**。如果视频流与录像都由官方平台提供，并且平台已开放 API：
  - 你可仅部署前端（Vercel/任意静态托管）+ 直接调用平台 API（或通过简单反向代理）
- 只有当你希望额外增加：
  - 统一鉴权/权限控制/审计
  - 统一域名反代（尤其 ws）
  - 限流与安全边界
  才需要一个后端服务（Railway 只是其中一种托管方式；自建 Nginx 通常更稳更省成本）。

### 15.4 R2（对象存储）需要吗？
- 如果 **录像存储由官方平台承担**：通常 **不需要 R2**。
- 如果要 **自建录像/回放**：
  - R2/S3 适合存放录像文件（长期/低成本扩展）
  - 但这会引入后端录像服务、索引、回放生成等工程量（远不止前端托管）。

---

## 16) 录像“存一段时间”的实现路径（与前端托管无关的关键点）
### 16.1 最省事路径（优先向厂家确认）
- 让 **官方平台负责录像计划/存储管理/回放接口**
- 我们的管理平台只做：
  - 录像查询（按通道/时间段）
  - 获取回放 URL
  - 播放/下载

### 16.2 自建录像（可选，工程量更大）
- 录原始码流（H265/H264 均可）或统一转码后录像（H264 更通用）
- 回放时输出 HLS/FLV/WebRTC 给浏览器
- 若要规模化并发与成本可控，通常需要硬件加速（GPU/QSV）与调度/监控体系
