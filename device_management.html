<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta name="x-poe-datastore-behavior" content="local_only">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' data: blob: https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://code.jquery.com https://unpkg.com https://d3js.org https://threejs.org https://cdn.plot.ly https://stackpath.bootstrapcdn.com https://maps.googleapis.com https://cdn.tailwindcss.com https://ajax.googleapis.com https://kit.fontawesome.com https://cdn.datatables.net https://maxcdn.bootstrapcdn.com https://code.highcharts.com https://tako-static-assets-production.s3.amazonaws.com https://www.youtube.com https://fonts.googleapis.com https://fonts.gstatic.com https://pfst.cf2.poecdn.net https://puc.poecdn.net https://i.imgur.com https://wikimedia.org https://*.icons8.com https://*.giphy.com https://picsum.photos https://images.unsplash.com; frame-src 'self' https://www.youtube.com https://trytako.com; child-src 'self'; manifest-src 'self'; worker-src 'self'; upgrade-insecure-requests; block-all-mixed-content;">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>设备管理 - 极简布局骨架</title>
  <style>
    /* 延续 admin_panel.html 的“极简黑描边骨架”风格 */
    * { box-sizing: border-box; }
    html, body { height: 100%; margin: 0; }
    body { font-family: sans-serif; }
    button, input, select { font: inherit; }
    a { color: inherit; }

    .app { height: 100%; display: flex; flex-direction: column; min-height: 0; }

    /* 顶部导航（同 admin_panel.html） */
    .topbar {
      height: 56px;
      display: flex;
      align-items: stretch;
      border-bottom: 1px solid #000;
    }
    .top-left {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 0 12px;
      min-width: 240px;
      border-right: 1px solid #000;
      white-space: nowrap;
    }
    .top-left a {
      color: inherit;
      text-decoration: none;
      cursor: pointer;
    }
    .top-left a:hover { text-decoration: underline; }
    .top-center {
      display: flex;
      align-items: stretch;
      gap: 0;
      flex: 1;
    }
    .nav-item {
      display: flex;
      align-items: center;
      padding: 0 18px;
      border-right: 1px solid #000;
      cursor: pointer;
      user-select: none;
      position: relative;
      gap: 8px;
    }
    .nav-item[aria-current="page"] { font-weight: 700; }
    .dropdown {
      display: none;
      position: absolute;
      top: 56px;
      left: 0;
      border: 1px solid #000;
      background: #fff;
      min-width: 160px;
      z-index: 10;
    }
    .dropdown a {
      display: block;
      padding: 10px 12px;
      border-bottom: 1px solid #000;
      text-decoration: none;
    }
    .dropdown a:hover { text-decoration: underline; }
    .dropdown a:last-child { border-bottom: 0; }
    .nav-item.open .dropdown { display: block; }
    .top-right {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 0 12px;
      min-width: 360px;
      border-left: 1px solid #000;
    }
    .top-right input { width: 100%; }

    /* 主体 */
    .main {
      flex: 1;
      min-height: 0;
      display: grid;
      grid-template-rows: 44px 1fr;
    }

    .breadcrumb {
      border-bottom: 1px solid #000;
      padding: 10px 12px;
      display: flex;
      align-items: center;
      gap: 8px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .page {
      min-height: 0;
      overflow: auto;
      padding: 12px;
    }

    .toolbar {
      border: 1px solid #000;
      padding: 10px;
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 10px;
      align-items: center;
    }

    .toolbar-left {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }
    .toolbar-right {
      display: grid;
      grid-template-columns: 1fr 44px;
      gap: 6px;
      align-items: center;
      min-width: 280px;
    }

    .table-wrap {
      margin-top: 10px;
      border: 1px solid #000;
      overflow: auto;
      min-height: 0;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 1120px;
    }
    thead th {
      position: sticky;
      top: 0;
      background: #fff;
      border-bottom: 1px solid #000;
      padding: 10px 8px;
      text-align: left;
      white-space: nowrap;
    }
    tbody td {
      border-top: 1px solid #000;
      padding: 10px 8px;
      vertical-align: top;
      white-space: nowrap;
    }
    tbody tr:hover { background: #f6f6f6; }

    .status-online { font-weight: 700; }
    .status-offline { color: #666; }

    .ops {
      display: flex;
      gap: 6px;
      align-items: center;
      flex-wrap: wrap;
    }
    .ops button {
      padding: 4px 8px;
      border: 1px solid #000;
      background: transparent;
      cursor: pointer;
    }
    .ops button:disabled { opacity: 0.5; cursor: not-allowed; }

    .pager {
      margin-top: 10px;
      display: flex;
      justify-content: space-between;
      gap: 10px;
      align-items: center;
      padding: 10px;
      border: 1px solid #000;
    }
    .pager .left { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
    .pager .right { display: flex; gap: 6px; align-items: center; }

    dialog {
      border: 1px solid #000;
      padding: 0;
      width: min(720px, calc(100% - 24px));
    }
    dialog::backdrop { background: rgba(0,0,0,.2); }
    .dlg-hd {
      border-bottom: 1px solid #000;
      padding: 10px 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }
    .dlg-bd { padding: 12px; }
    .form-grid {
      display: grid;
      grid-template-columns: 120px 1fr;
      gap: 10px;
      align-items: center;
    }
    .dlg-ft {
      border-top: 1px solid #000;
      padding: 10px 12px;
      display: flex;
      justify-content: flex-end;
      gap: 8px;
    }

    @media (max-width: 900px) {
      .top-right { min-width: 220px; }
      .toolbar { grid-template-columns: 1fr; }
      .toolbar-right { min-width: 0; }
      table { min-width: 960px; }
    }
  </style>
</head>

<body>
  <div class="app">
    <header class="topbar" role="banner">
      <div class="top-left">
        <strong>Apex CCTV</strong>
        <span>|</span>
        <a href="homepage.html">首页</a>
      </div>

      <nav class="top-center" aria-label="主导航">
        <div class="nav-item" data-nav="video">
          <a href="admin_panel.html" style="text-decoration:none;">视频</a>
        </div>

        <div class="nav-item" aria-current="page" data-nav="device">
          设备
          <div class="dropdown" role="menu" aria-label="设备菜单">
            <a href="device_management.html" role="menuitem">设备管理</a>
            <a href="#" role="menuitem">分组管理</a>
          </div>
        </div>

        <div class="nav-item" data-nav="user">
          用户
          <div class="dropdown" role="menu" aria-label="用户菜单">
            <a href="user_management.html" role="menuitem">用户管理</a>
            <a href="#" role="menuitem">角色管理</a>
          </div>
        </div>

        <div class="nav-item" data-nav="gallery">
          图库
          <div class="dropdown" role="menu" aria-label="图库菜单">
            <a href="#" role="menuitem">网关告警</a>
            <a href="#" role="menuitem">协议告警</a>
            <a href="#" role="menuitem">1400告警</a>
          </div>
        </div>

        <div class="nav-item" data-nav="ai">
          AI 分析
        </div>

        <div class="nav-item" data-nav="config">
          配置
          <div class="dropdown" role="menu" aria-label="配置菜单">
            <a href="#" role="menuitem">基础配置</a>
            <a href="#" role="menuitem">录像配置</a>
            <a href="#" role="menuitem">告警配置</a>
            <a href="#" role="menuitem">设备接入</a>
            <a href="#" role="menuitem">运维管理</a>
          </div>
        </div>
      </nav>

      <div class="top-right">
        <span>功能搜索</span>
        <input placeholder="请输入搜索内容" aria-label="功能搜索">
        <span>管理员</span>
      </div>
    </header>

    <div class="main">
      <div class="breadcrumb" aria-label="面包屑">
        <strong>设备管理</strong>
        <span>|</span>
        <span>设备</span>
      </div>

      <section class="page" aria-label="设备管理内容区">
        <div class="toolbar" aria-label="设备管理工具栏">
          <div class="toolbar-left">
            <button type="button" id="btnAdd">+ 添加设备</button>

            <label>
              <span style="margin-right:6px;">筛选</span>
              <select id="filterProtocol" aria-label="协议筛选">
                <option value="">全部协议</option>
                <option value="GB/T28181">GB/T28181</option>
                <option value="EHOME">EHOME</option>
                <option value="TCP">TCP</option>
              </select>
            </label>

            <label>
              <select id="filterStatus" aria-label="状态筛选">
                <option value="">全部状态</option>
                <option value="在线">在线</option>
                <option value="离线">离线</option>
              </select>
            </label>

            <button type="button" id="btnCleanInvalid">清理无效数据</button>
            <button type="button" id="btnDeleteOfflinePage">删除本页离线设备</button>
            <button type="button" id="btnImport">导入</button>
            <button type="button" id="btnExport">导出</button>
            <button type="button" id="btnDetect">设备检测</button>

            <input id="fileImport" type="file" accept=".csv,text/csv" style="display:none;">
          </div>

          <div class="toolbar-right">
            <input id="keyword" placeholder="设备 / 编码 / 协议" aria-label="关键字搜索">
            <button type="button" id="btnSearch">搜</button>
          </div>
        </div>

        <div class="table-wrap" aria-label="设备列表表格容器">
          <table aria-label="设备列表">
            <thead>
              <tr>
                <th style="width:72px;">编号</th>
                <th style="width:180px;">名称</th>
                <th style="width:240px;">设备编码</th>
                <th style="width:140px;">接入协议</th>
                <th style="width:90px;">状态</th>
                <th style="width:72px;">通道</th>
                <th style="width:100px;">节点</th>
                <th style="width:90px;">更新</th>
                <th style="width:90px;">启用</th>
                <th style="width:140px;">协议</th>
                <th style="width:220px;">操作</th>
              </tr>
            </thead>
            <tbody id="tbody">
              <!-- JS 渲染 -->
            </tbody>
          </table>
        </div>

        <div class="pager" aria-label="分页">
          <div class="left">
            <span id="countText">共 0 条</span>
            <label>
              每页
              <select id="pageSize">
                <option value="5">5</option>
                <option value="10" selected>10</option>
                <option value="20">20</option>
              </select>
              条
            </label>
          </div>
          <div class="right">
            <button type="button" id="btnPrev">上一页</button>
            <span id="pageText">第 1 / 1 页</span>
            <button type="button" id="btnNext">下一页</button>
          </div>
        </div>
      </section>

    </div>
  </div>

  <dialog id="dlg">
    <div class="dlg-hd">
      <strong id="dlgTitle">添加设备</strong>
      <button type="button" id="btnCloseDlg">关闭</button>
    </div>
    <div class="dlg-bd">
      <form id="formDevice">
        <div class="form-grid">
          <label for="fName">名称</label>
          <input id="fName" required placeholder="例如：大华枪机">

          <label for="fCode">设备编码</label>
          <input id="fCode" required placeholder="例如：34020000001320000001">

          <label for="fAccess">接入协议</label>
          <select id="fAccess" required>
            <option value="GB/T28181">GB/T28181</option>
            <option value="EHOME">EHOME</option>
            <option value="TCP">TCP</option>
          </select>

          <label for="fStatus">状态</label>
          <select id="fStatus" required>
            <option value="在线">在线</option>
            <option value="离线">离线</option>
          </select>

          <label for="fChannels">通道</label>
          <input id="fChannels" type="number" min="0" value="1" required>

          <label for="fEnabled">启用</label>
          <input id="fEnabled" type="checkbox" checked>
        </div>
      </form>
    </div>
    <div class="dlg-ft">
      <button type="button" id="btnCancel">取消</button>
      <button type="button" id="btnSave">保存</button>
    </div>
  </dialog>

  <script>
    // 顶部“下拉菜单”点击开合（同 admin_panel.html）
    const navItems = document.querySelectorAll('.nav-item');
    function closeAll() { navItems.forEach(i => i.classList.remove('open')); }
    navItems.forEach(item => {
      item.addEventListener('click', (e) => {
        const hasDropdown = item.querySelector('.dropdown');
        if (!hasDropdown) { closeAll(); return; }
        const isOpen = item.classList.contains('open');
        closeAll();
        if (!isOpen) item.classList.add('open');
        e.stopPropagation();
      });
    });
    document.addEventListener('click', closeAll);
    document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeAll(); });

    // 设备页：基础数据与交互（纯前端占位）
    /** @type {{id:number,name:string,code:string,access:string,status:'在线'|'离线',channels:number,node:string,protocol:string,enabled:boolean,invalid?:boolean}[]} */
    let devices = [
      { id: 8,  name: '大华枪机',   code: '34020000001330000001', access: 'GB/T28181', status: '在线', channels: 1, node: '-', protocol: 'TCP 被动', enabled: true },
      { id: 22, name: '澳洲测试',   code: '34020000001320000001', access: 'GB/T28181', status: '在线', channels: 2, node: '-', protocol: 'TCP 被动', enabled: true },
      { id: 24, name: '临沂3Q测试', code: '34020000001320000002', access: 'GB/T28181', status: '在线', channels: 2, node: '-', protocol: 'TCP 被动', enabled: true },
      { id: 26, name: '安焦',       code: '34020000001320000003', access: 'GB/T28181', status: '离线', channels: 2, node: '-', protocol: 'TCP 被动', enabled: false, invalid: true },
      { id: 27, name: '安焦@home',  code: 'GN3381581',            access: 'EHOME',    status: '离线', channels: 2, node: '-', protocol: 'TCP',      enabled: true },
    ];

    let page = 1;
    let pageSize = 10;

    const tbody = document.getElementById('tbody');
    const countText = document.getElementById('countText');
    const pageText = document.getElementById('pageText');
    const btnPrev = document.getElementById('btnPrev');
    const btnNext = document.getElementById('btnNext');

    const keywordEl = document.getElementById('keyword');
    const filterProtocolEl = document.getElementById('filterProtocol');
    const filterStatusEl = document.getElementById('filterStatus');
    const pageSizeEl = document.getElementById('pageSize');

    function normalize(s) { return String(s ?? '').trim().toLowerCase(); }

    function getFiltered() {
      const kw = normalize(keywordEl.value);
      const p = filterProtocolEl.value;
      const st = filterStatusEl.value;

      return devices.filter(d => {
        const kwHit = !kw || (
          normalize(d.name).includes(kw) ||
          normalize(d.code).includes(kw) ||
          normalize(d.access).includes(kw) ||
          normalize(d.protocol).includes(kw)
        );
        const pHit = !p || d.access === p;
        const stHit = !st || d.status === st;
        return kwHit && pHit && stHit;
      });
    }

    function render() {
      const filtered = getFiltered();
      const total = filtered.length;
      const totalPages = Math.max(1, Math.ceil(total / pageSize));
      if (page > totalPages) page = totalPages;
      if (page < 1) page = 1;

      const start = (page - 1) * pageSize;
      const rows = filtered.slice(start, start + pageSize);

      countText.textContent = `共 ${total} 条`;
      pageText.textContent = `第 ${page} / ${totalPages} 页`;
      btnPrev.disabled = page <= 1;
      btnNext.disabled = page >= totalPages;

      tbody.innerHTML = rows.map(d => {
        const statusClass = d.status === '在线' ? 'status-online' : 'status-offline';
        const invalidMark = d.invalid ? '（无效）' : '';
        const checked = d.enabled ? 'checked' : '';
        return `
          <tr data-id="${d.id}">
            <td>${d.id}</td>
            <td>${escapeHtml(d.name)} ${invalidMark}</td>
            <td>${escapeHtml(d.code)}</td>
            <td>${escapeHtml(d.access)}</td>
            <td class="${statusClass}">${d.status}</td>
            <td>${d.channels}</td>
            <td>${escapeHtml(d.node)}</td>
            <td><button type="button" data-act="refresh">更新</button></td>
            <td><input type="checkbox" data-act="toggle" ${checked} aria-label="启用开关"></td>
            <td>${escapeHtml(d.protocol)}</td>
            <td>
              <div class="ops">
                <button type="button" data-act="detail">摘要</button>
                <button type="button" data-act="edit">编辑</button>
                <button type="button" data-act="flow">流程</button>
                <button type="button" data-act="delete">删除</button>
              </div>
            </td>
          </tr>
        `;
      }).join('');
    }

    function escapeHtml(str) {
      return String(str ?? '')
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#39;');
    }

    // 分页
    btnPrev.addEventListener('click', () => { page -= 1; render(); });
    btnNext.addEventListener('click', () => { page += 1; render(); });
    pageSizeEl.addEventListener('change', () => {
      pageSize = Number(pageSizeEl.value) || 10;
      page = 1;
      render();
    });

    // 搜索/筛选
    document.getElementById('btnSearch').addEventListener('click', () => { page = 1; render(); });
    keywordEl.addEventListener('keydown', (e) => { if (e.key === 'Enter') { page = 1; render(); } });
    filterProtocolEl.addEventListener('change', () => { page = 1; render(); });
    filterStatusEl.addEventListener('change', () => { page = 1; render(); });

    // 表格操作委托
    tbody.addEventListener('click', (e) => {
      const target = e.target;
      if (!(target instanceof HTMLElement)) return;
      const tr = target.closest('tr');
      if (!tr) return;
      const id = Number(tr.getAttribute('data-id'));
      const d = devices.find(x => x.id === id);
      if (!d) return;
      const act = target.getAttribute('data-act');
      if (!act) return;

      if (act === 'delete') {
        if (!confirm(`确定删除设备「${d.name}」？`)) return;
        devices = devices.filter(x => x.id !== id);
        render();
        return;
      }
      if (act === 'detail') {
        alert(`摘要\n\n名称：${d.name}\n编码：${d.code}\n协议：${d.access}\n状态：${d.status}\n通道：${d.channels}`);
        return;
      }
      if (act === 'flow') {
        alert('流程（占位）：可在此打开接入/注册/心跳/媒体流状态等。');
        return;
      }
      if (act === 'refresh') {
        alert('更新（占位）：可在此触发设备信息同步/状态刷新。');
        return;
      }
      if (act === 'edit') {
        openDialog('edit', d);
        return;
      }
    });

    tbody.addEventListener('change', (e) => {
      const target = e.target;
      if (!(target instanceof HTMLElement)) return;
      const act = target.getAttribute('data-act');
      if (act !== 'toggle') return;
      const tr = target.closest('tr');
      if (!tr) return;
      const id = Number(tr.getAttribute('data-id'));
      const d = devices.find(x => x.id === id);
      if (!d) return;
      d.enabled = !!(target instanceof HTMLInputElement && target.checked);
    });

    // 工具栏按钮
    document.getElementById('btnCleanInvalid').addEventListener('click', () => {
      const before = devices.length;
      devices = devices.filter(d => !d.invalid);
      const removed = before - devices.length;
      alert(`清理完成：移除 ${removed} 条无效数据（占位规则：invalid=true）。`);
      render();
    });

    document.getElementById('btnDeleteOfflinePage').addEventListener('click', () => {
      const filtered = getFiltered();
      const start = (page - 1) * pageSize;
      const rows = filtered.slice(start, start + pageSize);
      const offlineIds = new Set(rows.filter(d => d.status === '离线').map(d => d.id));
      const before = devices.length;
      devices = devices.filter(d => !offlineIds.has(d.id));
      const removed = before - devices.length;
      alert(`已删除本页离线设备：${removed} 条`);
      render();
    });

    document.getElementById('btnDetect').addEventListener('click', () => {
      alert('设备检测（占位）：可在此批量探测在线/注册/通道连通性。');
    });

    // 导出 CSV（当前筛选后的全部）
    document.getElementById('btnExport').addEventListener('click', () => {
      const filtered = getFiltered();
      const headers = ['id','name','code','access','status','channels','node','protocol','enabled'];
      const lines = [
        headers.join(','),
        ...filtered.map(d => headers.map(k => csvCell(d[k])).join(',')),
      ];
      const blob = new Blob([lines.join('\n')], { type: 'text/csv;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `devices_${new Date().toISOString().slice(0,10)}.csv`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    });

    function csvCell(v) {
      const s = String(v ?? '');
      const escaped = s.replaceAll('"', '""');
      return `"${escaped}"`;
    }

    // 导入 CSV（简单：覆盖/追加）
    const fileImport = document.getElementById('fileImport');
    document.getElementById('btnImport').addEventListener('click', () => fileImport.click());
    fileImport.addEventListener('change', async () => {
      const file = fileImport.files?.[0];
      if (!file) return;
      const text = await file.text();
      const rows = parseCsv(text);
      if (!rows.length) { alert('导入失败：CSV 为空'); return; }
      const headers = rows[0].map(h => normalize(h));
      const idx = (name) => headers.indexOf(normalize(name));
      const required = ['name','code','access','status'];
      const missing = required.filter(k => idx(k) < 0);
      if (missing.length) { alert(`导入失败：缺少列 ${missing.join(', ')}`); return; }

      let nextId = Math.max(0, ...devices.map(d => d.id)) + 1;
      let added = 0;
      for (const r of rows.slice(1)) {
        const name = r[idx('name')]?.trim();
        const code = r[idx('code')]?.trim();
        const access = r[idx('access')]?.trim() || 'GB/T28181';
        const status = (r[idx('status')]?.trim() === '在线') ? '在线' : '离线';
        if (!name || !code) continue;
        devices.push({
          id: nextId++,
          name,
          code,
          access,
          status,
          channels: Number(r[idx('channels')] ?? 1) || 1,
          node: r[idx('node')]?.trim() || '-',
          protocol: r[idx('protocol')]?.trim() || (access === 'EHOME' ? 'TCP' : 'TCP 被动'),
          enabled: (r[idx('enabled')]?.trim() ?? 'true') !== 'false',
        });
        added += 1;
      }
      alert(`导入完成：新增 ${added} 条`);
      fileImport.value = '';
      render();
    });

    function parseCsv(text) {
      // 极简 CSV 解析（支持双引号，逗号分隔；不处理多行字段）
      const lines = String(text ?? '').split(/\r?\n/).filter(l => l.trim().length);
      return lines.map(line => {
        const out = [];
        let cur = '';
        let inQuote = false;
        for (let i = 0; i < line.length; i++) {
          const ch = line[i];
          if (ch === '"') {
            if (inQuote && line[i + 1] === '"') { cur += '"'; i++; continue; }
            inQuote = !inQuote;
            continue;
          }
          if (ch === ',' && !inQuote) { out.push(cur); cur = ''; continue; }
          cur += ch;
        }
        out.push(cur);
        return out;
      });
    }

    // 弹窗：添加/编辑
    const dlg = document.getElementById('dlg');
    const dlgTitle = document.getElementById('dlgTitle');
    const fName = document.getElementById('fName');
    const fCode = document.getElementById('fCode');
    const fAccess = document.getElementById('fAccess');
    const fStatus = document.getElementById('fStatus');
    const fChannels = document.getElementById('fChannels');
    const fEnabled = document.getElementById('fEnabled');
    let editingId = null;

    function openDialog(mode, d) {
      editingId = mode === 'edit' ? d.id : null;
      dlgTitle.textContent = mode === 'edit' ? '编辑设备' : '添加设备';
      fName.value = mode === 'edit' ? d.name : '';
      fCode.value = mode === 'edit' ? d.code : '';
      fAccess.value = mode === 'edit' ? d.access : 'GB/T28181';
      fStatus.value = mode === 'edit' ? d.status : '在线';
      fChannels.value = mode === 'edit' ? String(d.channels) : '1';
      fEnabled.checked = mode === 'edit' ? !!d.enabled : true;
      dlg.showModal();
    }

    function closeDialog() { dlg.close(); }
    document.getElementById('btnAdd').addEventListener('click', () => openDialog('add'));
    document.getElementById('btnCloseDlg').addEventListener('click', closeDialog);
    document.getElementById('btnCancel').addEventListener('click', closeDialog);
    dlg.addEventListener('click', (e) => {
      // 点击遮罩关闭
      const rect = dlg.getBoundingClientRect();
      const inDialog = e.clientX >= rect.left && e.clientX <= rect.right && e.clientY >= rect.top && e.clientY <= rect.bottom;
      if (!inDialog) closeDialog();
    });

    document.getElementById('btnSave').addEventListener('click', () => {
      const form = document.getElementById('formDevice');
      if (!form.reportValidity()) return;

      const payload = {
        name: fName.value.trim(),
        code: fCode.value.trim(),
        access: fAccess.value,
        status: fStatus.value,
        channels: Number(fChannels.value) || 1,
        enabled: !!fEnabled.checked,
      };
      if (!payload.name || !payload.code) return;

      if (editingId != null) {
        const d = devices.find(x => x.id === editingId);
        if (d) {
          Object.assign(d, payload);
          d.protocol = payload.access === 'EHOME' ? 'TCP' : 'TCP 被动';
        }
      } else {
        const nextId = Math.max(0, ...devices.map(d => d.id)) + 1;
        devices.unshift({
          id: nextId,
          ...payload,
          node: '-',
          protocol: payload.access === 'EHOME' ? 'TCP' : 'TCP 被动',
        });
      }
      closeDialog();
      render();
    });

    // 初次渲染
    render();
  </script>
</body>
</html>
